# ç™»å½•çŠ¶æ€ç®¡ç†ç³»ç»Ÿæ”¹è¿›

## æ¦‚è¿°

æœ¬æ¬¡æ”¹è¿›å®ç°äº†ç³»ç»ŸåŒ–çš„å¤šå¹³å°ç™»å½•çŠ¶æ€ç®¡ç†æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š

1. **Cookie è¿‡æœŸæ—¶é—´ç®¡ç†** - åŸºäº Cookie æœ‰æ•ˆæœŸè‡ªåŠ¨åˆ¤æ–­ç™»å½•çŠ¶æ€
2. **æ‡’åŠ è½½æ£€æµ‹æœºåˆ¶** - ç”¨æˆ·é€‰æ‹©å¹³å°æ—¶æ‰æ£€æµ‹ï¼Œå‡å°‘ä¸å¿…è¦çš„ API è°ƒç”¨
3. **è‡ªåŠ¨æ‰“å¼€ç™»å½•é¡µ** - ç™»å½•å¤±æ•ˆæ—¶è‡ªåŠ¨å¼•å¯¼ç”¨æˆ·é‡æ–°ç™»å½•
4. **æ‰‹åŠ¨å‘å¸ƒé™çº§** - API ä¸å¯ç”¨æ—¶æä¾›æ‰‹åŠ¨å‘å¸ƒå…¥å£

## æ–°å¢åŠŸèƒ½

### 1. Cookie è¿‡æœŸæ—¶é—´ç®¡ç†

**æ–‡ä»¶**: `apps/extension/src/background/platform-api.ts`

```typescript
// è·å– Cookie æœ€æ—©è¿‡æœŸæ—¶é—´
function getCookieEarliestExpiration(
  cookies: chrome.cookies.Cookie[],
  sessionCookieNames: string[]
): number | undefined

// è·å–å¹³å° Cookie è¿‡æœŸä¿¡æ¯
export async function getPlatformCookieExpiration(platform: string): Promise<{
  hasValidCookies: boolean;
  cookieExpiresAt?: number;
  isExpiringSoon?: boolean;  // 24å°æ—¶å†…è¿‡æœŸ
}>
```

**Account ç±»å‹æ‰©å±•** (`packages/core/src/types/index.ts`):
```typescript
interface Account {
  // ... åŸæœ‰å­—æ®µ
  cookieExpiresAt?: number;      // Cookie æœ€æ—©è¿‡æœŸæ—¶é—´
  needsLazyCheck?: boolean;      // æ˜¯å¦éœ€è¦æ‡’åŠ è½½æ£€æµ‹
}
```

### 2. æ‡’åŠ è½½æ£€æµ‹æœºåˆ¶

**æ–‡ä»¶**: `apps/extension/src/background/account-service.ts`

```typescript
// æ‡’åŠ è½½æ£€æµ‹å•ä¸ªè´¦å·
static async lazyCheckAccount(account: Account, forceCheck = false): Promise<{
  needsRelogin: boolean;
  isExpiringSoon: boolean;
  account: Account;
}>

// æ‰¹é‡æ‡’åŠ è½½æ£€æµ‹
static async lazyCheckAccounts(accounts: Account[]): Promise<{
  valid: Account[];
  needsRelogin: Account[];
  expiringSoon: Account[];
}>
```

**æ£€æµ‹ç­–ç•¥**:
1. å¦‚æœ Cookie æœªè¿‡æœŸä¸”è·ç¦»ä¸Šæ¬¡æ£€æµ‹ä¸è¶…è¿‡ 30 åˆ†é’Ÿï¼Œè·³è¿‡æ£€æµ‹
2. å¦‚æœ Cookie å³å°†è¿‡æœŸï¼ˆ24å°æ—¶å†…ï¼‰ï¼Œæ ‡è®°éœ€è¦é‡æ–°ç™»å½•
3. å¦åˆ™è¿›è¡Œå®Œæ•´çš„ API æ£€æµ‹

### 3. è‡ªåŠ¨æ‰“å¼€ç™»å½•é¡µ

```typescript
// è‡ªåŠ¨æ‰“å¼€å¹³å°ç™»å½•é¡µ
static async autoOpenLoginPage(account: Account, options?: {
  active?: boolean;
  waitForLogin?: boolean;
}): Promise<{ success: boolean; tabId?: number }>
```

### 4. æ‰‹åŠ¨å‘å¸ƒé™çº§

```typescript
// è·å–æ‰‹åŠ¨å‘å¸ƒ URL
static getManualPublishUrl(platform: string): string | null

// æ‰“å¼€æ‰‹åŠ¨å‘å¸ƒé¡µé¢
static async openManualPublishPage(platform: string): Promise<boolean>
```

**æ”¯æŒçš„å¹³å°æ‰‹åŠ¨å‘å¸ƒ URL**:
- æ˜é‡‘: `https://juejin.cn/editor/drafts/new`
- CSDN: `https://editor.csdn.net/md`
- çŸ¥ä¹: `https://zhuanlan.zhihu.com/write`
- å¾®ä¿¡å…¬ä¼—å·: `https://mp.weixin.qq.com/`
- ç®€ä¹¦: `https://www.jianshu.com/writer`
- åšå®¢å›­: `https://i.cnblogs.com/posts/edit`
- 51CTO: `https://blog.51cto.com/blogger/publish`
- è…¾è®¯äº‘: `https://cloud.tencent.com/developer/article/write`
- é˜¿é‡Œäº‘: `https://developer.aliyun.com/article/new`
- æ€å¦: `https://segmentfault.com/write`
- Bç«™: `https://member.bilibili.com/platform/upload/text/edit`
- å¼€æºä¸­å›½: `https://my.oschina.net/u/home/publish`

## æ–°å¢æ¶ˆæ¯ç±»å‹

**æ–‡ä»¶**: `apps/extension/src/background/index.ts`

| æ¶ˆæ¯ç±»å‹ | è¯´æ˜ |
|---------|------|
| `LAZY_CHECK_ACCOUNT` | æ‡’åŠ è½½æ£€æµ‹å•ä¸ªè´¦å· |
| `LAZY_CHECK_ACCOUNTS` | æ‰¹é‡æ‡’åŠ è½½æ£€æµ‹ |
| `AUTO_OPEN_LOGIN_PAGE` | è‡ªåŠ¨æ‰“å¼€ç™»å½•é¡µ |
| `GET_MANUAL_PUBLISH_URL` | è·å–æ‰‹åŠ¨å‘å¸ƒ URL |
| `OPEN_MANUAL_PUBLISH_PAGE` | æ‰“å¼€æ‰‹åŠ¨å‘å¸ƒé¡µé¢ |
| `CHECK_ACCOUNT_EXPIRATION` | æ£€æŸ¥è´¦å·è¿‡æœŸçŠ¶æ€ |

## UI æ”¹è¿›

**æ–‡ä»¶**: `apps/extension/src/ui/options/views/Accounts.vue`

1. **å³å°†è¿‡æœŸæç¤º**: æ˜¾ç¤º "å³å°†è¿‡æœŸ" æ ‡ç­¾ï¼Œæç¤ºç”¨æˆ·ç™»å½•å°†åœ¨ X å°æ—¶åè¿‡æœŸ
2. **æ‡’åŠ è½½æ£€æµ‹æŒ‰é’®**: "æ£€æµ‹" æŒ‰é’®æ›¿ä»£åŸæ¥çš„ "åˆ·æ–°" æŒ‰é’®
3. **æ‰‹åŠ¨å‘å¸ƒå…¥å£**: è´¦å·å¤±æ•ˆæ—¶æ˜¾ç¤º "ğŸ“ æ‰‹åŠ¨å‘å¸ƒ" æŒ‰é’®
4. **è¿‡æœŸæ—¶é—´æ ¼å¼åŒ–**: æ˜¾ç¤ºå‹å¥½çš„è¿‡æœŸæ—¶é—´ï¼ˆå¦‚ "12å°æ—¶30åˆ†é’Ÿ"ï¼‰

## ä½¿ç”¨ç¤ºä¾‹

### æ‡’åŠ è½½æ£€æµ‹
```typescript
// ç”¨æˆ·é€‰æ‹©å¹³å°æ—¶æ£€æµ‹
const result = await chrome.runtime.sendMessage({
  type: 'LAZY_CHECK_ACCOUNT',
  data: { account, forceCheck: false },
});

if (result.needsRelogin) {
  // æç¤ºç”¨æˆ·é‡æ–°ç™»å½•
} else if (result.isExpiringSoon) {
  // æç¤ºç”¨æˆ·ç™»å½•å³å°†è¿‡æœŸ
}
```

### è‡ªåŠ¨æ‰“å¼€ç™»å½•é¡µ
```typescript
const result = await chrome.runtime.sendMessage({
  type: 'AUTO_OPEN_LOGIN_PAGE',
  data: { 
    account,
    options: { active: true, waitForLogin: false }
  },
});
```

### æ‰‹åŠ¨å‘å¸ƒé™çº§
```typescript
const result = await chrome.runtime.sendMessage({
  type: 'OPEN_MANUAL_PUBLISH_PAGE',
  data: { platform: 'juejin' },
});
```

## æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      UI Layer (Vue)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æ‡’åŠ è½½æ£€æµ‹  â”‚  â”‚ å³å°†è¿‡æœŸæç¤º â”‚  â”‚ æ‰‹åŠ¨å‘å¸ƒé™çº§æŒ‰é’®   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                â”‚                   â”‚
          â–¼                â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Background Service                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                  AccountService                          â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚
â”‚  â”‚  â”‚lazyCheck     â”‚  â”‚autoOpenLogin â”‚  â”‚openManualPage â”‚ â”‚â”‚
â”‚  â”‚  â”‚Account()     â”‚  â”‚Page()        â”‚  â”‚()             â”‚ â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚            â”‚                                                 â”‚
â”‚            â–¼                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                  platform-api.ts                         â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚
â”‚  â”‚  â”‚getCookieEarliestExp  â”‚  â”‚getPlatformCookieExp     â”‚ â”‚â”‚
â”‚  â”‚  â”‚iration()             â”‚  â”‚iration()                â”‚ â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Chrome APIs                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚chrome.cookiesâ”‚  â”‚chrome.tabs  â”‚  â”‚chrome.storage       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
